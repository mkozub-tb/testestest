name: Auto Merge uat to int

on:
  pull_request:
    types:
      - closed

jobs:
  pre_notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up Git
        run: |
          echo "no dzialaj zesz no"
          echo ${{secrets.GITHUB_TOKEN}}
          git config user.name "mkozub-tb"
          git config user.email "marcin.kozub@thinkbeyond.cloud"
          git clone https://mkozub-tb:${{secrets.GITHUB_TOKEN}}@github.com/mkozub-tb/testestest.git testFolder
          cd testFolder
          git checkout main

      - name: Set Success Status For All Open PRS
        run: |
          # Replace the following variables with your values
          GITHUB_TOKEN=${{secrets.GITHUB_TOKEN}}
          
          STATE="success"  # Can be "success", "failure", "pending", etc.
          CONTEXT="custom-check-v2"  # A unique identifier for your status
          
          # List all open pull requests targeting the branch
          PRS=$(curl -s "https://api.github.com/repos/$GITHUB_REPOSITORY/pulls?state=open&base=uat" -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" | jq -r '.[].number')
          
          # Iterate through the pull requests and set a status
          for PR_NUMBER in $PRS; do
            echo $PR_NUMBER
            response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/$GITHUB_REPOSITORY/pulls/$PR_NUMBER")
            
            COMMIT_SHA=$(echo "$response" | jq -r '.head.sha')
            echo $COMMIT_SHA
          
            curl -X POST "https://api.github.com/repos/$GITHUB_REPOSITORY/statuses/$COMMIT_SHA" \
              -H "Authorization: token $GITHUB_TOKEN" \
              -d "{\"state\":\"$STATE\",\"context\":\"$CONTEXT\",\"description\":\"Custom status description for all pull requests\"}"
          done


  merge_uat_to_int:
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'uat'
    runs-on: ubuntu-latest
    needs: pre_notify
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up Git
        run: |
          echo "boli boli boli"
          sleep 10
          echo ${{secrets.GITHUB_TOKEN}}
          git config user.name "mkozub-tb"
          git config user.email "marcin.kozub@thinkbeyond.cloud"
          git clone https://mkozub-tb:${{secrets.GITHUB_TOKEN}}@github.com/mkozub-tb/testestest.git testFolder
          cd testFolder
          git checkout main

      - name: Fetch all branches from origin
        run: |
          git fetch origin '+refs/heads/*:refs/remotes/origin/*'

      - name: Create and checkout temp-merge branch
        run: |
          git checkout -b temp-merge uat

      - name: Merge uat to int
        run: |
          echo "ale glupotka hihi"
          git checkout int
          git pull
          git merge --no-ff --no-edit --allow-unrelated-histories --strategy-option ours temp-merge
          git push origin int

#  post_notify:
#    runs-on: ubuntu-latest
#    needs: merge_uat_to_int
#
#    steps:
#      - name: Checkout Repository
#        uses: actions/checkout@v2
#
#      - name: Set up Git
#        run: |
#          echo "test"
#          echo ${{secrets.GITHUB_TOKEN}}
#          git config user.name "mkozub-tb"
#          git config user.email "marcin.kozub@thinkbeyond.cloud"
#          git clone https://mkozub-tb:${{secrets.GITHUB_TOKEN}}@github.com/mkozub-tb/testestest.git testFolder
#          cd testFolder
#          git checkout main
#
#      - name: Set Success Status
#        run: |
#          # Replace the following variables with your values
#          GITHUB_TOKEN=${{secrets.GITHUB_TOKEN}}
#          COMMIT_SHA=$(git rev-parse HEAD)
#          STATE="success"  # Can be "success", "failure", "pending", etc.
#          CONTEXT="custom-check-v2"  # A unique identifier for your status
#
#          # Create a status using the GitHub API
#          curl -X POST "https://api.github.com/repos/$GITHUB_REPOSITORY/statuses/$COMMIT_SHA" \
#            -H "Authorization: token $GITHUB_TOKEN" \
#            -d "{\"state\":\"$STATE\",\"context\":\"$CONTEXT\",\"description\":\"Custom status description\"}"